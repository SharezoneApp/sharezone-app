# Copyright (c) 2022 Sharezone UG (haftungsbeschr√§nkt)
# Licensed under the EUPL-1.2-or-later.
#
# You may obtain a copy of the Licence at:
# https://joinup.ec.europa.eu/software/page/eupl
#
# SPDX-License-Identifier: EUPL-1.2

# This workflow handles the CI for the docs.
#
# Therefore, it's only triggered on pull requests that make changes to the
# docs. It only contains jobs that require secrets. The jobs that don't
# require secrets are handled in the "safe_docs_ci.yml" workflow.

name: temp

concurrency:
  group: temp-${{ github.head_ref }}
  # In order to conserve the use of GitHub Actions, we cancel the running action
  # of the previous commit. This means that if you first commit "A" and then
  # commit "B" to the pull request a few minutes later, the workflow for commit
  # "A" will be cancelled.
  cancel-in-progress: true

on:
  # Triggers the workflow on pull request events
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      # It's important to trigger this workflow again when the pull is changing
      # from a draft pull request to a ready for review pull request.
      #
      # Some jobs are skipped when the pull request is a draft. Therefore, we
      # need to trigger these jobs again when the pull request is changing to
      # ready for review.
      - ready_for_review
      # Retrigger the workflow when label has been add to run the CI when the
      # "safe to test" label is added.
      - labeled
  merge_group:
    types:
      - checks_requested

# Set permissions to none.
#
# Using the broad default permissions is considered a bad security practice
# and would cause alerts from our scanning tools.
permissions: {}

jobs:
  web-preview:
    runs-on: ubuntu-22.04
    permissions:
      pull-requests: write # for FirebaseExtended/action-hosting-deploy to comment on PRs
      checks: write # for FirebaseExtended/action-hosting-deploy to comment on PRs (without write permissions for checks the action doesn't post a comment to the PR, we don't know why)
    steps:
      - name: Ensure PR has "safe to test" label, if PR is from a fork
        uses: SharezoneApp/verify-safe-to-test-label@c1059d43fc918756660a700ca6d08e445ff314a2

      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          # Because we are using the "pull_request_target" event, we need to
          # checkout the PR head commit instead of the merge commit.
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Install dependencies
        run: npm install -C docs/

      - name: Build
        run: npm run build -C docs/

      - name: Setup Node.js
        uses: actions/setup-node@cdca7365b2dadb8aad0a33bc7601856ffabcc48e
        with:
          node-version: "20"

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@120e124148ab7016bec2374e5050f15051255ba2
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_SHAREZONE_DEBUG }}
          projectId: sharezone-debug
          entryPoint: "./docs"
          # The expiration date shouldn't be too high, because if we open a lot
          # of pull requests, we will run out of quota (we get 429 errors).
          expires: "3d"
          target: "docs"
        env:
          # Required to deploy Next.js applications to Firebase Hosting
          FIREBASE_CLI_EXPERIMENTS: webframeworks
