# Copyright (c) 2022 Sharezone UG (haftungsbeschr√§nkt)
# Licensed under the EUPL-1.2-or-later.
#
# You may obtain a copy of the Licence at:
# https://joinup.ec.europa.eu/software/page/eupl
#
# SPDX-License-Identifier: EUPL-1.2

name: licence-ci

# Controls when the action will run.
on:
  merge_group:
    types:
      - checks_requested
  # Triggers the workflow on pull request events
  pull_request:
    types:
      - opened
      - synchronize

# Set permissions to none.
#
# Using the broad default permissions is considered a bad security practice
# and would cause alerts from our scanning tools.
permissions: {}

jobs:
  check-files-licence-headers:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608
      - uses: actions/setup-go@bfd2fb341f32be7281829126376a12a780ca79fc
        with:
          go-version: "^1.13.1"
      - run: go install github.com/google/addlicense@v1.1.1
      - run: ./bin/check_license_headers.sh

  check-dependency-licenses:
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608

      - name: Set Flutter version from FVM config file to environment variables
        uses: kuhnroyal/flutter-fvm-config-action@6ffa30473b346f7d7c63cf9e03e6a886f940a72b

      - uses: subosito/flutter-action@2783a3f08e1baf891508463f8c6653c258246225
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: ${{ env.FLUTTER_CHANNEL }}
          # Use format expected by FVM.
          # Else this won't be recognized as an installed version when setting
          # '.../flutter' as the FVM Flutter version cache folder.
          cache-path: "${{ runner.tool_cache }}/flutter/:version:"

      - name: Install FVM
        run: |
          flutter pub global activate fvm 2.4.1
          fvm config --cache-path '${{ runner.tool_cache }}/flutter'

      - name: Activate license_checker
        run: fvm dart pub global activate license_checker 1.6.0

      - name: Check licenses in app
        run: |
          cd app
          fvm flutter pub get
          lic_ck check-licenses --config ../licenses_config.yaml --problematic

      - name: Check licenses in sz cli
        run: |
          cd tools/sz_repo_cli
          fvm dart pub get
          lic_ck check-licenses --config ../../licenses_config.yaml --problematic
